- name: Copy docker-compose file
  template:
    src: templates/docker-compose/docker-compose-initial.yml.j2
    dest: "{{ csgo_server_path }}/docker-compose-initial.yml"
    owner: "{{ csgo_user_name }}"
    group: "{{ csgo_user_name }}"
  become: true

- name: Tear down existing services
  docker_compose:
    project_src: "{{ csgo_server_path }}"
    files: docker-compose-initial.yml
    remove_orphans: true
    state: absent
  become: true

- name: Pull latest raks321/linuxgsm-docker image
  docker_image:
    name: raks321/linuxgsm-docker
    source: pull
  become: true

- name: Check if initial csgo server files need to be installed
  stat:
    path: "{{ csgo_server_path }}/log/script/csgoserver-steamcmd.log"
  register: csgo_initial_install
  become: true
  
- name: Report if files are installed
  debug:
    msg: "CSGO Initial Server files have been installed"
  when: csgo_initial_install.stat.exists

- name: Install initial files
  docker_compose:
    project_src: "{{ csgo_server_path }}"
    remove_orphans: true
    files: docker-compose-initial.yml
  when: not csgo_initial_install.stat.exists
  become: true

- name: Wait until service has installed or updated (1h timeout with 60s intervals)
  wait_for:
    path: "{{ csgo_server_path }}/log/script/csgoserver-script.log"
    search_regex: "Success! App '740' already up to date. | Success! App '740' fully installed. | No update available"
    delay: 30
    sleep: 60
    timeout: 3600
  when: not csgo_initial_install.stat.exists
  become: true

- name: Tear down existing services
  docker_compose:
    project_src: "{{ csgo_server_path }}"
    files: docker-compose-initial.yml
    remove_orphans: true
    state: absent
  when: not csgo_initial_install.stat.exists
  become: true

- name: Folder for downloaded files
  file:
    path: "{{ csgo_server_path }}/downloads"
    state: directory
    owner: "{{ csgo_user_name }}"
    group: "{{ csgo_user_name }}"
    mode: 0755
  become: true

- name: Download csgo addons
  get_url:
    url: "{{ item.url }}"
    dest: "{{ csgo_server_path }}/downloads/{{ item.name }}-{{ item.version }}.tar.gz"
    mode: 0755
  loop:
    - "{{ sourcemod }}"
    - "{{ mmsource }}"
    - "{{ steamworks }}"
    - "{{ get5 }}"
    - "{{ get5ws }}"
  become: true

- name: Extract csgo addons
  unarchive:
    src: "{{ csgo_server_path }}/downloads/{{ item.name }}-{{ item.version }}.tar.gz"
    dest: "{{ csgo_server_path }}/serverfiles/csgo/addons"
    remote_src: yes
    owner: "{{ csgo_user_name }}"
    group: "{{ csgo_user_name }}"
    mode: 0755
  loop:
    - "{{ sourcemod }}"
    - "{{ mmsource }}"
    - "{{ steamworks }}"
    - "{{ get5 }}"
    - "{{ get5ws }}"
  become: true

- name: Move using rsync Steamworks to addons Folder
  shell: rsync -a "{{ csgo_server_path }}/serverfiles/csgo/addons/package/addons/" "{{ csgo_server_path }}/serverfiles/csgo/addons/"
  become: true

- name: Move using rsync get5ws to sourcemod Folder
  shell: rsync -a "{{ csgo_server_path }}/serverfiles/csgo/addons/G5WS.smx" "{{ csgo_server_path }}/serverfiles/csgo/addons/sourcemod/plugins/G5WS.smx"
  become: true